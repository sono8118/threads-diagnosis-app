# 診断ページ（P-001）E2Eテスト仕様書

生成日: 2026-01-15
対象ページ: `/diagnosis`
権限レベル: 不要（匿名アクセス可能）

---

## テスト環境

```yaml
URL: http://localhost:3247/diagnosis
認証: 不要（匿名診断）
データ保存: sessionStorage（ブラウザタブ閉じるまで保持）
```

---

## 統合テストでカバー済み（E2Eから除外）

- ❌ なし（バックエンド不在のため、統合テスト不在）
- ✅ フロントエンドのみのMVPプロジェクト
- ✅ 全てのロジックはフロントエンドで完結

---

## E2Eテスト項目一覧（UIフローのみ: 8項目）

| ID | テスト項目 | 期待結果 |
|----|----------|---------|
| E2E-DIAG-001 | 診断開始画面の表示と同意チェック | タイトル「Threads運用診断」表示、同意チェック後に診断開始ボタンクリック可能、GA4イベント`Diagnosis_Start`送信 |
| E2E-DIAG-002 | 質問1表示と選択肢クリック | 質問1表示、4択選択肢クリック、次へボタン有効化 |
| E2E-DIAG-003 | 複数質問の連続回答フロー | 質問1-3回答、プログレスバー更新（25%）、残り設問数「あと9問」表示 |
| E2E-DIAG-004 | 戻るボタンによる質問戻り | 質問3から戻るボタンクリック、質問2表示、前回答が選択状態で保持 |
| E2E-DIAG-005 | 未選択時の次へボタン無効化 | 質問表示、選択なし、次へボタンdisabled状態 |
| E2E-DIAG-006 | 12問全回答完了と完了画面表示 | 質問12まで回答、完了画面「おつかれさまでした！」表示、GA4イベント`Diagnosis_Complete`送信 |
| E2E-DIAG-007 | sessionStorage保存確認 | 診断完了後、sessionStorageに`threads_diagnosis_session`キーでデータ保存確認（answers/computedType/computedScores/timestamp） |
| E2E-DIAG-008 | 診断完了後の結果ページ自動遷移 | 完了画面表示後1.5秒で/result自動遷移 |

---

## 詳細テストケース

### E2E-DIAG-001: 診断開始画面の表示と同意チェック

**前提条件**: なし（初回アクセス）

**操作手順**:
1. ブラウザで`http://localhost:3247/diagnosis`にアクセス
2. タイトル「Threads運用診断」が表示されることを確認
3. 説明文「12問（2〜3分）で、「Threadsしんどい理由」がやさしく見えてきます」が表示されることを確認
4. 同意チェックボックスをクリック（カード全体クリック可能）
5. 「診断を始める」ボタンをクリック

**期待結果**:
- タイトル、説明文が正しく表示される
- 同意チェックボックスがクリック可能（カード全体がクリック可能）
- 同意後、診断開始ボタンがクリック可能
- ボタンクリック後、GA4イベント`Diagnosis_Start`が送信される
- 質問1画面に遷移

---

### E2E-DIAG-002: 質問1表示と選択肢クリック

**前提条件**: 診断開始済み（E2E-DIAG-001完了）

**操作手順**:
1. 質問1「Q1. あなたの発信って、どんな人に向けてますか？」が表示されることを確認
2. プログレスバー「質問 1 / 12」表示確認
3. 4択選択肢のうち1つをクリック
4. 選択肢がハイライト表示（青背景、チェックアイコン）されることを確認
5. 次へボタンが有効化されることを確認

**期待結果**:
- 質問1が正しく表示される
- プログレスバーが「質問 1 / 12」を表示
- 選択肢クリックで視覚的フィードバック（青背景、チェックアイコン）
- 次へボタンがdisabled→enabled状態に変化

---

### E2E-DIAG-003: 複数質問の連続回答フロー

**前提条件**: 質問1表示中（E2E-DIAG-002完了）

**操作手順**:
1. 質問1の選択肢を選択し、次へボタンクリック
2. 質問2の選択肢を選択し、次へボタンクリック
3. 質問3の選択肢を選択し、次へボタンクリック
4. プログレスバーが「質問 3 / 12」を表示することを確認
5. 残り設問数「あと9問」が表示されることを確認

**期待結果**:
- 質問1→2→3とスムーズに遷移
- プログレスバーが更新される（25%）
- 残り設問数が正しく表示される（12 - 3 = 9問）

---

### E2E-DIAG-004: 戻るボタンによる質問戻り

**前提条件**: 質問3表示中（E2E-DIAG-003完了）

**操作手順**:
1. 質問3画面で「戻る」ボタンが表示されることを確認
2. 戻るボタンをクリック
3. 質問2が表示されることを確認
4. 質問2で選択した選択肢が選択状態で保持されていることを確認

**期待結果**:
- 質問1以降は戻るボタンが表示される
- 戻るボタンクリックで前の質問に戻る
- 前回の回答が選択状態で保持される（Zustand状態管理による）

---

### E2E-DIAG-005: 未選択時の次へボタン無効化

**前提条件**: 任意の質問表示中

**操作手順**:
1. 質問画面表示時、次へボタンがdisabled状態であることを確認
2. 選択肢をクリックせずに次へボタンをクリック（無反応であることを確認）

**期待結果**:
- 選択肢未選択時、次へボタンがdisabled状態
- クリックしても次の質問に進まない

---

### E2E-DIAG-006: 12問全回答完了と完了画面表示

**前提条件**: 質問11まで回答済み

**操作手順**:
1. 質問12の選択肢を選択
2. 次へボタンをクリック
3. 完了画面「おつかれさまでした！」が表示されることを確認
4. 「あなたの診断結果をまとめています...」メッセージ表示確認
5. ローディングアニメーション（3つの点）表示確認

**期待結果**:
- 完了画面が表示される
- GA4イベント`Diagnosis_Complete`が送信される（タイプ・スコア付き）
- 1.5秒後に自動遷移開始（E2E-DIAG-008）

---

### E2E-DIAG-007: sessionStorage保存確認

**前提条件**: 診断完了（E2E-DIAG-006完了）

**操作手順**:
1. ブラウザDevToolsでsessionStorageを確認
2. `threads_diagnosis_session`キーが存在することを確認
3. データ構造を確認:
   - `answers`: 12問の回答配列
   - `computedType`: T1/T2/T3/T4/BEGINNER/BALANCED
   - `computedScores`: 4軸スコア（design/production/improvement/business）
   - `customMessages`: カスタムメッセージ配列
   - `timestamp`: セッション作成日時

**期待結果**:
- sessionStorageにデータが正しく保存される
- データ構造が仕様通り

---

### E2E-DIAG-008: 診断完了後の結果ページ自動遷移

**前提条件**: 完了画面表示中（E2E-DIAG-006完了）

**操作手順**:
1. 完了画面表示から1.5秒待機
2. 自動的に`/result`ページに遷移することを確認

**期待結果**:
- 1.5秒後に自動遷移
- 遷移先URL: `http://localhost:3247/result`

---

## 実行コマンド

```bash
# E2Eテスト実行（Playwrightを使用する場合）
npx playwright test tests/e2e/diagnosis.spec.ts

# 単一テストケース実行
npx playwright test tests/e2e/diagnosis.spec.ts -g "E2E-DIAG-001"

# ヘッドレスモード無効（ブラウザ表示）
npx playwright test tests/e2e/diagnosis.spec.ts --headed

# デバッグモード
npx playwright test tests/e2e/diagnosis.spec.ts --debug
```

---

## 注意事項

- **sessionStorage特性**: ブラウザタブを閉じるとデータが自動削除される
- **GA4イベント**: 開発環境では実際に送信されないことがある（GTMプレビューモードで確認推奨）
- **戻るボタン**: 診断ページ内のみ有効（結果ページからは戻れない）
- **自動遷移**: 完了画面表示後1.5秒で自動的に結果ページへ遷移

---

## テスト対象外（範囲外）

- ❌ レスポンシブ表示（E2E範囲外）
- ❌ アクセシビリティ（E2E範囲外）
- ❌ パフォーマンス（E2E範囲外）
- ❌ エラーハンドリング（MVP範囲外）
- ❌ 同意チェックなしでの診断開始（UIで制御済み）

---

**仕様書バージョン**: 1.0.0
**最終更新日**: 2026-01-15
